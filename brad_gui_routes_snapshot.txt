"""
Brad's Single-User Multi-Client GUI
Desktop-optimized interface for managing multiple tenant clients with:
- R2 primary storage + Google Drive fallback
- Claude Sonnet 4.5 AI coding assistant
- Laptop/external display layouts (1920x1080+)
- Streaming-friendly design
"""
from flask import Blueprint, render_template, jsonify, request, session
import os
import json
from datetime import datetime

brad_bp = Blueprint('brad_gui', __name__, url_prefix='/brad')

# Storage status check (uses existing storage_manager)
try:
    from storage_manager import upload_file, download_file, list_files
    STORAGE_AVAILABLE = True
except ImportError:
    STORAGE_AVAILABLE = False

# Client data directory
CLIENTS_DIR = os.path.join(os.path.dirname(__file__), 'data', 'brad_clients')
os.makedirs(CLIENTS_DIR, exist_ok=True)

def _get_clients():
    """Load all clients for Brad's account"""
    clients_file = os.path.join(CLIENTS_DIR, 'clients.json')
    if os.path.exists(clients_file):
        with open(clients_file, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {"clients": [], "active_client_id": None}

def _save_clients(data):
    """Save clients list"""
    clients_file = os.path.join(CLIENTS_DIR, 'clients.json')
    with open(clients_file, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2)

def _get_storage_health():
    """Check R2 and Google Drive status"""
    health = {
        "r2": {"status": "unknown", "available": False, "message": ""},
        "gdrive": {"status": "unknown", "available": False, "message": ""},
        "local": {"status": "healthy", "available": True, "message": "Local storage active"}
    }
    
    if not STORAGE_AVAILABLE:
        health["r2"]["message"] = "Storage manager not loaded"
        health["gdrive"]["message"] = "Storage manager not loaded"
        return health
    
    # Check R2 (primary)
    try:
        test_data = b"health_check"
        result = upload_file("_health_check", "test.txt", test_data)
        if result.get("r2"):
            health["r2"] = {"status": "healthy", "available": True, "message": "R2 operational"}
        else:
            health["r2"] = {"status": "degraded", "available": False, "message": "R2 unavailable (credentials?)"}
    except Exception as e:
        health["r2"] = {"status": "error", "available": False, "message": str(e)}
    
    # Check Google Drive (fallback)
    try:
        if result.get("gdrive"):
            health["gdrive"] = {"status": "healthy", "available": True, "message": "Google Drive operational"}
        else:
            health["gdrive"] = {"status": "degraded", "available": False, "message": "Google Drive unavailable"}
    except Exception as e:
        health["gdrive"] = {"status": "error", "available": False, "message": str(e)}
    
    return health

@brad_bp.route("/")
def dashboard():
    """Main Brad dashboard"""
    clients_data = _get_clients()
    storage_health = _get_storage_health()
    
    return render_template('brad_gui/dashboard_enhanced.html',
                         clients=clients_data["clients"],
                         active_client_id=clients_data["active_client_id"],
                         storage_health=storage_health,
                         ai_provider=os.getenv('AI_PROVIDER', 'not_configured'))

@brad_bp.route("/api/clients", methods=["GET"])
def list_clients():
    """Get all clients"""
    data = _get_clients()
    return jsonify(data)

@brad_bp.route("/api/clients", methods=["POST"])
def add_client():
    """Add new client"""
    client_data = request.get_json()
    
    # Validate required fields
    required = ["name", "contact"]
    if not all(k in client_data for k in required):
        return jsonify({"error": "Missing required fields"}), 400
    
    data = _get_clients()
    
    # Generate client ID
    client_id = f"client_{len(data['clients']) + 1:03d}"
    
    new_client = {
        "id": client_id,
        "name": client_data["name"],
        "contact": client_data["contact"],
        "address": client_data.get("address", ""),
        "case_number": client_data.get("case_number", ""),
        "created_at": datetime.now().isoformat(),
        "status": "active",
        "notes": client_data.get("notes", "")
    }
    
    data["clients"].append(new_client)
    
    # Set as active if first client
    if not data["active_client_id"]:
        data["active_client_id"] = client_id
    
    _save_clients(data)
    
    return jsonify({"success": True, "client": new_client})

@brad_bp.route("/api/clients/<client_id>", methods=["PUT"])
def update_client(client_id):
    """Update client details"""
    updates = request.get_json()
    data = _get_clients()
    
    client = next((c for c in data["clients"] if c["id"] == client_id), None)
    if not client:
        return jsonify({"error": "Client not found"}), 404
    
    # Update fields
    for key in ["name", "contact", "address", "case_number", "status", "notes"]:
        if key in updates:
            client[key] = updates[key]
    
    client["updated_at"] = datetime.now().isoformat()
    
    _save_clients(data)
    
    return jsonify({"success": True, "client": client})

@brad_bp.route("/api/clients/<client_id>/activate", methods=["POST"])
def activate_client(client_id):
    """Switch active client"""
    data = _get_clients()
    
    client = next((c for c in data["clients"] if c["id"] == client_id), None)
    if not client:
        return jsonify({"error": "Client not found"}), 404
    
    data["active_client_id"] = client_id
    _save_clients(data)
    
    return jsonify({"success": True, "active_client_id": client_id})

@brad_bp.route("/api/storage/health", methods=["GET"])
def storage_health():
    """Get storage backend health status"""
    health = _get_storage_health()
    return jsonify(health)

@brad_bp.route("/api/ai/chat", methods=["POST"])
def ai_chat():
    """AI coding assistant (Claude Sonnet 4.5)"""
    data = request.get_json()
    prompt = data.get("prompt", "")
    context = data.get("context", "")
    
    if not prompt:
        return jsonify({"error": "Missing prompt"}), 400
    
    # Route to existing copilot system
    try:
        from copilot_routes import generate_response  # If exists
        response = generate_response(prompt, context)
        return jsonify({"response": response})
    except ImportError:
        # Fallback: direct AI provider call
        ai_provider = os.getenv('AI_PROVIDER', 'openai')
        
        if ai_provider == 'openai':
            # OpenAI API call
            import openai
            openai.api_key = os.getenv('OPENAI_API_KEY')
            
            completion = openai.ChatCompletion.create(
                model="gpt-4",  # Or Claude via API if configured
                messages=[
                    {"role": "system", "content": "You are a helpful coding assistant for a tenant rights platform."},
                    {"role": "user", "content": f"{context}\n\n{prompt}"}
                ]
            )
            
            return jsonify({"response": completion.choices[0].message.content})
        else:
            return jsonify({"error": "AI provider not configured"}), 500

@brad_bp.route("/client/<client_id>")
def client_detail(client_id):
    """Client detail view"""
    data = _get_clients()
    client = next((c for c in data["clients"] if c["id"] == client_id), None)
    
    if not client:
        return "Client not found", 404
    
    storage_health = _get_storage_health()
    
    return render_template('brad_gui/client_detail.html',
                         client=client,
                         storage_health=storage_health)

@brad_bp.route("/settings")
def settings():
    """Brad's settings page"""
    storage_health = _get_storage_health()
    
    config = {
        "r2_configured": bool(os.getenv('R2_ACCESS_KEY_ID')),
        "gdrive_configured": os.path.exists('security/gdrive_credentials.json'),
        "ai_provider": os.getenv('AI_PROVIDER', 'not_configured'),
        "ai_key_set": bool(os.getenv('OPENAI_API_KEY') or os.getenv('AZURE_OPENAI_KEY'))
    }
    
    return render_template('brad_gui/settings.html',
                         storage_health=storage_health,
                         config=config)

# Health check
@brad_bp.route("/health")
def health():
    """Brad GUI health check"""
    return jsonify({
        "status": "healthy",
        "storage_manager": STORAGE_AVAILABLE,
        "clients_count": len(_get_clients()["clients"])
    })


