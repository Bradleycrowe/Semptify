<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Semptify - Tenant justice automation made simple. Open-source Flask app for streamlined release management and admin workflows.">
    <title>SemptifyGUI - Tenant Justice Automation</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <meta name="theme-color" content="#2563eb">
  </head>
  <body>
    <!-- Hero Section -->
    <header class="hero">
      <div class="hero-content">
        <h1>Semptify<span class="accent">GUI</span></h1>
        <p class="tagline">Tenant Justice Automation - Simple, Secure, Transparent</p>
        <p class="subtitle">Open-source Flask-based interface for release management, admin workflows, and operational transparency</p>
        <div class="cta-buttons">
          <a href="#features" class="btn btn-primary">Learn More</a>
          <a href="/admin" class="btn btn-secondary">Admin Portal</a>
        </div>
      </div>
    </header>

    <!-- Live Status Panel -->
    <section class="status-panel">
      <h2>System Status</h2>
      <div class="status-grid" id="statusGrid">
        <div class="status-item">
          <span class="label">Health:</span>
          <span class="value" id="healthStatus">Checking...</span>
        </div>
        <div class="status-item">
          <span class="label">Version:</span>
          <span class="value" id="versionInfo">Loading...</span>
        </div>
        <div class="status-item">
          <span class="label">Requests:</span>
          <span class="value" id="requestCount">-</span>
        </div>
        <div class="status-item">
          <span class="label">Security Mode:</span>
          <span class="value" id="securityMode">-</span>
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="features">
      <h2>What Semptify Does</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h3>üîê Secure Admin Portal</h3>
          <p>Multi-token authentication with break-glass support, CSRF protection, and configurable security modes (open or enforced).</p>
        </div>
        <div class="feature-card">
          <h3>üìä Observability First</h3>
          <p>Prometheus metrics, structured event logging, real-time status endpoints, and SBOM transparency for supply-chain visibility.</p>
        </div>
        <div class="feature-card">
          <h3>üöÄ Release Automation</h3>
          <p>Streamlined GitHub release workflows, semantic versioning support, and automated CI/CD integration.</p>
        </div>
        <div class="feature-card">
          <h3>üåê Progressive Web App</h3>
          <p>Installable on any device with offline fallback, responsive design, and theme customization (light/dark mode).</p>
        </div>
        <div class="feature-card">
          <h3>üîÑ Token Rotation</h3>
          <p>Self-service admin token rotation with audit logging and one-shot break-glass emergency access.</p>
        </div>
        <div class="feature-card">
          <h3>üõ°Ô∏è Rate Limiting</h3>
          <p>Sliding-window rate limiting per IP and path to protect admin endpoints from abuse.</p>
        </div>
      </div>
    </section>

    <!-- Core Actions -->
    <section id="quickstart" class="core-actions">
      <h2>Quick Start</h2>
      <div class="action-cards">
        <div class="action-card">
          <h3>Explore Admin Panel</h3>
          <p>Access the admin interface to manage releases, view SBOM history, rotate tokens, and trigger workflows.</p>
          <a href="/admin" class="btn btn-primary">Go to Admin</a>
        </div>
        <div class="action-card">
          <h3>Check Metrics</h3>
          <p>View Prometheus-compatible metrics including request counts, rate limits, and operational events.</p>
          <a href="/metrics" class="btn btn-secondary">View Metrics</a>
        </div>
        <div class="action-card">
          <h3>System Health</h3>
          <p>Verify service health and runtime configuration for deployment monitoring and alerting.</p>
          <a href="/healthz" class="btn btn-secondary">Health Check</a>
        </div>
      </div>
    </section>

    <!-- Architecture Overview -->
    <section id="architecture" class="architecture">
      <h2>How It Works</h2>
      <p class="arch-intro">Semptify is built on Flask with a focus on simplicity, security, and transparency:</p>
      <ol class="arch-list">
        <li><strong>Authentication Layer:</strong> Token-based auth with hashed credentials stored in <code>security/admin_tokens.json</code></li>
        <li><strong>Event Logging:</strong> Structured JSON logs in <code>logs/events.log</code> for audit trails and debugging</li>
        <li><strong>Rate Limiting:</strong> In-memory sliding-window protection configured via <code>ADMIN_RATE_WINDOW</code> and <code>ADMIN_RATE_MAX</code></li>
        <li><strong>Metrics Collection:</strong> Prometheus counters for requests, errors, releases, rate limits, and token rotations</li>
        <li><strong>Release Workflow:</strong> GitHub API integration for tag creation, workflow triggers, and release history</li>
        <li><strong>SBOM Generation:</strong> Automated supply-chain transparency with Syft-generated SBOMs for each release</li>
      </ol>
    </section>

    <!-- Deployment Info -->
    <section id="deployment" class="deployment">
      <h2>Deployment</h2>
      <p>Semptify deploys anywhere Python and Flask run - from local dev to cloud platforms like Render, Heroku, or Kubernetes.</p>
      <h3>Runtime Folders (Auto-Created):</h3>
      <ul class="folder-list">
        {% for f in folders %}
        <li><code>{{ f }}/</code> - {{ folder_descriptions.get(f, 'Runtime data') }}</li>
        {% endfor %}
      </ul>
      <p class="deploy-note">
        <strong>Production Tip:</strong> Set <code>SECURITY_MODE=enforced</code> and <code>FLASK_SECRET</code> env vars, and provide <code>security/admin_tokens.json</code> with hashed tokens.
      </p>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <p>
        <a href="https://github.com/Bradleycrowe/SemptifyGUI" target="_blank">View on GitHub</a> |
        <a href="/version">Version Info</a> |
        <a href="/admin/status">System Status (JSON)</a>
      </p>
      <p class="theme-toggle-container">
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
          <span id="themeIcon">üåô</span> Toggle Theme
        </button>
      </p>
    </footer>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/js/service-worker.js')
          .then(reg => console.log('SW registered', reg))
          .catch(err => console.log('SW registration failed', err));
      }
    </script>

    <!-- Status Polling & Theme Toggle -->
    <script>
      // Theme Toggle
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = localStorage.getItem('theme') || 'light';
      
      if (currentTheme === 'dark') {
        document.body.classList.add('dark-theme');
        themeIcon.textContent = '‚òÄÔ∏è';
      }
      
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // Status Polling
      async function updateStatus() {
        try {
          // Health check
          const healthResp = await fetch('/health');
          document.getElementById('healthStatus').textContent = healthResp.ok ? '‚úì OK' : '‚úó Down';
          document.getElementById('healthStatus').className = healthResp.ok ? 'value success' : 'value error';
          
          // Version info
          const versionResp = await fetch('/version');
          if (versionResp.ok) {
            const versionData = await versionResp.json();
            const sha = versionData.git_sha.substring(0, 7);
            document.getElementById('versionInfo').textContent = sha !== 'unknown' ? sha : 'dev';
          }
          
          // Metrics (request count)
          const metricsResp = await fetch('/metrics');
          if (metricsResp.ok) {
            const metricsText = await metricsResp.text();
            const reqMatch = metricsText.match(/^requests_total (\d+)/m);
            if (reqMatch) {
              document.getElementById('requestCount').textContent = reqMatch[1];
            }
          }
          
          // Try to get admin status (may fail if not authorized)
          try {
            const statusResp = await fetch('/admin/status');
            if (statusResp.ok) {
              const statusData = await statusResp.json();
              document.getElementById('securityMode').textContent = statusData.security_mode.toUpperCase();
            }
          } catch (e) {
            // Expected to fail in enforced mode without token
            document.getElementById('securityMode').textContent = 'ENFORCED';
          }
        } catch (error) {
          console.error('Status update failed:', error);
        }
      }
      
      // Initial update and periodic refresh
      updateStatus();
      setInterval(updateStatus, 15000);  // Every 15 seconds
      
      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    </script>
  </body>
</html>
