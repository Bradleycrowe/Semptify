<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communication Suite Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .section {
      background: #fff;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #modal-buttons, #voice-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    button {
      padding: 10px 15px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0052a3;
    }
    #modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    #modal-content {
      font-size: 14px;
      line-height: 1.6;
      color: #666;
      margin-bottom: 20px;
    }
    .language-selector {
      margin: 10px 0;
    }
    .language-selector select {
      padding: 5px;
      font-size: 14px;
    }
    .close-btn, .modal-close {
      padding: 10px 20px;
      background: #ccc;
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .close-btn:hover, .modal-close:hover {
      background: #999;
    }
    .voice-status {
      padding: 10px;
      background: #e8f4f8;
      border-left: 4px solid #0066cc;
      margin: 10px 0;
      border-radius: 4px;
    }
    .error {
      color: #d9534f;
    }
    .success {
      color: #5cb85c;
    }
  </style>
</head>
<body>
  <h1>üéôÔ∏è Communication Suite Demo</h1>
  <p>Test modal triggers, voice commands, and multilingual help text wiring.</p>

  <!-- Modal Triggers Section -->
  <div class="section">
    <h2>Modal Triggers</h2>
    <p>Click a button to open a modal with help text from the FormalMethods module.</p>
    <div id="modal-buttons"></div>
  </div>

  <!-- Voice Triggers Section -->
  <div class="section">
    <h2>üéôÔ∏è Voice Triggers (Web Speech API)</h2>
    <p>Speak one of the trigger phrases to interact with the app.</p>
    <button onclick="startVoiceRecognition()">üé§ Start Listening</button>
    <button onclick="stopVoiceRecognition()">‚èπÔ∏è Stop Listening</button>
    <div class="voice-status" id="voice-status">Ready to listen...</div>
    <div id="voice-buttons"></div>
  </div>

  <!-- Language Selector -->
  <div class="section">
    <h2>Language</h2>
    <div class="language-selector">
      <label for="language-select">Select language:</label>
      <select id="language-select" onchange="changeLanguage()">
        <option value="en">English</option>
        <option value="es">Espa√±ol (Spanish)</option>
        <option value="som">Somali</option>
        <option value="hmn">Hmong</option>
      </select>
    </div>
  </div>

  <!-- Modal Overlay and Modal -->
  <div id="modal-overlay" onclick="closeModal()"></div>
  <div id="modal">
    <div id="modal-title"></div>
    <div id="modal-content"></div>
    <div class="language-selector">
      <label>Help text language:</label>
      <select id="modal-language-select" onchange="updateModalContent()">
        <option value="en">English</option>
        <option value="es">Espa√±ol</option>
        <option value="som">Somali</option>
        <option value="hmn">Hmong</option>
      </select>
    </div>
    <div style="margin-top: 15px;">
      <button class="modal-close" onclick="closeModal()">Close</button>
      <button onclick="speakModalContent()" style="background: #5cb85c; margin-left: 10px;">üîä Read Aloud</button>
    </div>
  </div>

  <script>
    let voiceRecognition = null;
    let isListening = false;
    let currentModalContent = '';
    let currentLanguage = 'en';
    let allMetadata = {};

    // Initialize Web Speech API
    function initVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        document.getElementById('voice-status').innerHTML = '<span class="error">Web Speech API not supported</span>';
        return;
      }
      voiceRecognition = new SpeechRecognition();
      voiceRecognition.continuous = true;
      voiceRecognition.interimResults = false;
      voiceRecognition.onstart = () => {
        updateVoiceStatus('Listening...', 'success');
      };
      voiceRecognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript.toLowerCase();
          handleVoiceCommand(transcript);
        }
      };
      voiceRecognition.onerror = (event) => {
        updateVoiceStatus(`Error: ${event.error}`, 'error');
      };
      voiceRecognition.onend = () => {
        if (isListening) {
          updateVoiceStatus('Stopped listening.', '');
        }
      };
    }

    function startVoiceRecognition() {
      if (!voiceRecognition) initVoiceRecognition();
      if (voiceRecognition && !isListening) {
        isListening = true;
        voiceRecognition.start();
      }
    }

    function stopVoiceRecognition() {
      if (voiceRecognition && isListening) {
        isListening = false;
        voiceRecognition.stop();
      }
    }

    function handleVoiceCommand(transcript) {
      updateVoiceStatus(`Heard: "${transcript}"`, 'success');
      const triggers = allMetadata.modal_triggers || {};
      for (const [triggerName, templateId] of Object.entries(triggers)) {
        if (transcript.includes(triggerName.toLowerCase())) {
          openModalForTrigger(triggerName, templateId);
          break;
        }
      }
    }

    function updateVoiceStatus(message, cssClass) {
      const status = document.getElementById('voice-status');
      status.textContent = message;
      if (cssClass) {
        status.className = `voice-status ${cssClass}`;
      } else {
        status.className = 'voice-status';
      }
    }

    // Fetch metadata and populate buttons
    function loadMetadata() {
      fetch('/comm/metadata')
        .then(r => r.json())
        .then(data => {
          allMetadata = data;
          populateModalButtons();
          populateVoiceButtons();
        })
        .catch(err => {
          console.error('Error loading metadata:', err);
          document.getElementById('modal-buttons').innerHTML = '<p class="error">Error loading module metadata</p>';
        });
    }

    function populateModalButtons() {
      const btns = document.getElementById('modal-buttons');
      btns.innerHTML = '';
      const triggers = allMetadata.modal_triggers || {};
      Object.entries(triggers).forEach(([triggerName, templateId]) => {
        const btn = document.createElement('button');
        btn.textContent = triggerName;
        btn.onclick = () => openModalForTrigger(triggerName, templateId);
        btns.appendChild(btn);
      });
    }

    function populateVoiceButtons() {
      const btns = document.getElementById('voice-buttons');
      btns.innerHTML = '<p><strong>Voice commands:</strong></p>';
      const triggers = allMetadata.modal_triggers || {};
      Object.keys(triggers).forEach(triggerName => {
        const btn = document.createElement('button');
        btn.textContent = `"${triggerName}"`;
        btn.style.background = '#5cb85c';
        btn.onclick = () => handleVoiceCommand(triggerName.toLowerCase());
        btns.appendChild(btn);
      });
    }

    function openModalForTrigger(triggerName, templateId) {
      document.getElementById('modal-title').textContent = triggerName;
      currentModalContent = (allMetadata.help_texts || {})[templateId] || {};
      updateModalContent();
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('modal').style.display = 'block';
    }

    function updateModalContent() {
      const lang = document.getElementById('modal-language-select').value;
      const helpText = currentModalContent[lang] || currentModalContent['en'] || 'No help text available.';
      document.getElementById('modal-content').textContent = helpText;
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = 'none';
      document.getElementById('modal').style.display = 'none';
    }

    function changeLanguage() {
      const lang = document.getElementById('language-select').value;
      currentLanguage = lang;
      document.getElementById('modal-language-select').value = lang;
    }

    function speakModalContent() {
      const text = document.getElementById('modal-content').textContent;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = currentLanguage === 'som' || currentLanguage === 'hmn' ? 'en' : currentLanguage;
      window.speechSynthesis.speak(utterance);
    }

    // Load metadata on page load
    window.onload = () => {
      loadMetadata();
      initVoiceRecognition();
    };
  </script>
</body>
</html>
