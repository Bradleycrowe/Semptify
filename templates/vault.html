<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Vault</title>
    <link rel="stylesheet" href="/static/css/app.css" />
  </head>
  <body>
    {% include '_nav.html' %}
    <h1>Document Vault</h1>
    <div class="legal-disclaimer-banner">
      <strong>{{ _('Note') }}:</strong> {{ _('You must be a registered user with your one-time token to access the Vault.') }}
    </div>
    <p>Welcome, {{ user.name }} (ID: {{ user.id }})</p>

    <section>
      <h2>Your Files</h2>
      <details>
        <summary>Ask Vault AI (local-only) using selected files</summary>
        <form id="vault-ai-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="user_token" value="{{ request.args.get('user_token','') }}">
          <p class="muted">Vault AI runs locally (Ollama). You can include file content (text-only, truncated) or just file metadata.</p>
          <p>
            <label>Question<br>
              <textarea id="vault-ai-prompt" rows="4" placeholder="What should I extract or summarize from these files?"></textarea>
            </label>
          </p>
          <p>
            <label><input type="checkbox" id="vault-ai-include"> Include file content (text snippets)</label>
          </p>
          <div>
            <strong>Select files:</strong>
            <div class="list">
              {% for f in files %}
                <div class="list-item"><label><input type="checkbox" class="vault-ai-file" value="{{ f.name }}"> {{ f.name }}</label> <small>({{ f.size }} bytes)</small></div>
              {% endfor %}
            </div>
          </div>
          <button type="submit">Ask Vault AI</button>
        </form>
        <pre id="vault-ai-answer" class="code-block muted hidden"></pre>
      </details>
    <section>
      <h2>Help</h2>
      <p class="muted">Quick steps to get the most out of your vault:</p>
      <ul><li>Upload important rental documents, notes, and evidence.</li><li>Use <a href="/copilot">AI Copilot</a> to draft letters or understand your rights. Only share what you’re comfortable with.</li><li>Create a read‑only share link for a trusted person under “Share (read‑only).”</li><li>Revoke any share at any time in “Manage shares.”</li><li>Explore <a href="/resources">Resources</a> for templates and Home Search (beta).</li></ul>
    </section>

  {% if files and files|length > 0 %}
  <div class="list">{% for f in files %}<div class="list-item"><a href="/vault/download/{{ f.name }}?user_token={{ request.args.get('user_token','') }}">{{ f.name }}</a> <small>({{ f.size }} bytes)</small></div>{% endfor %}</div>
      {% else %}
      <p><em>No files uploaded yet.</em></p>
      {% endif %}
    </section>

    <section>
      <h2>Upload</h2>
      <form action="/vault/upload" method="post" enctype="multipart/form-data" aria-label="Upload a file to your vault">
        <input type="hidden" name="user_token" value="{{ request.args.get('user_token','') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="vault-file">Choose file</label>
        <input id="vault-file" type="file" name="file" required title="Select a file to upload">
        <button type="submit">Upload</button>
      </form>
    </section>

    <section>
      <h2>Share (read-only)</h2>
      <p>Generate a private, time-limited link you can share with a trusted person (lawyer, case worker, caregiver). They can only view and download your files.</p>
      <form action="/vault/create_share" method="post">
        <input type="hidden" name="user_token" value="{{ request.args.get('user_token','') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="share-label">Label (who is this for?)</label>
        <input id="share-label" name="label" type="text" placeholder="e.g., Attorney Smith" />
        <label for="share-days">Expires in (days)</label>
        <input id="share-days" name="expires_days" type="number" min="1" max="90" value="30" />
        <div class="muted small">Quick presets: 
          <button type="button" class="link" onclick="document.getElementById('share-days').value=7">7d</button> · 
          <button type="button" class="link" onclick="document.getElementById('share-days').value=14">14d</button> · 
          <button type="button" class="link" onclick="document.getElementById('share-days').value=30">30d</button>
        </div>
        <input type="hidden" name="scope" value="vault_read" />
        <button type="submit">Create share link</button>
      </form>
    </section>

    <section>
      <h2>Manage shares</h2>
  {% if grants and grants|length > 0 %}
  <div class="list">{% for g in grants %}<div class="list-item"><strong>{{ g.label or 'Trusted person' }}</strong> <small>({{ g.id }})</small> {% if g.expires_ts %}<span class="muted">expires {{ g.expires_ts }}</span>{% endif %} <form action="/vault/revoke_share" method="post" class="inline"><input type="hidden" name="csrf_token" value="{{ csrf_token }}"><input type="hidden" name="user_token" value="{{ request.args.get('user_token','') }}"><input type="hidden" name="grant_id" value="{{ g.id }}"><button type="submit">Revoke</button></form></div>{% endfor %}</div>
      {% else %}
      <p><em>No active shares.</em></p>
      {% endif %}
    </section>
    {% include '_footer.html' %}
  </body>
  <script src="/static/js/help-panel.js"></script>
  <script>
    (function(){
      const form = document.getElementById('vault-ai-form');
  if(!form) return;
  const out = document.getElementById('vault-ai-answer');
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const prompt = document.getElementById('vault-ai-prompt').value.trim();
        const include = document.getElementById('vault-ai-include').checked;
        const csrf = form.querySelector('input[name="csrf_token"]').value;
        const userToken = form.querySelector('input[name="user_token"]').value;
        const files = Array.from(document.querySelectorAll('.vault-ai-file:checked')).map(el=>el.value);
  if(!prompt){ out.classList.remove('hidden'); out.textContent='Please enter a question.'; return; }
  out.classList.remove('hidden');
        out.textContent = 'Thinking…';
        try{
          const res = await fetch('/api/vault_copilot?user_token='+encodeURIComponent(userToken), {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRF-Token': csrf},
            body: JSON.stringify({ prompt, files, include_content: include })
          });
          const data = await res.json().catch(()=>({error: res.status+' '+res.statusText}));
          if(!res.ok){ out.textContent = 'Error: ' + (data.error || (res.status+' '+res.statusText)); }
          else{ out.textContent = data.output || '(empty)'; }
        }catch(err){ out.textContent = 'Request failed: ' + err; }
      });
    })();
  </script>
</html>
