<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  <title>Semptify Admin</title>
  <link rel="stylesheet" href="/static/css/admin.css" />
  </head>
  <body>
    <h1>Semptify Admin</h1>
    {% if security_mode == 'open' %}
      <div class="banner banner-open">SECURITY MODE: OPEN (no admin token enforcement). Do not use in production.</div>
    {% else %}
      <div class="banner banner-enforced">SECURITY MODE: ENFORCED</div>
      {% if token_ids %}
        <p><strong>Active Token IDs:</strong> {{ token_ids|join(', ') }}</p>
        <p><small>Break-glass requires file <code>security/breakglass.flag</code> + a breakglass token.</small></p>
        <form action="/rotate_token" method="post" class="rotate-form">
          <fieldset>
            <legend>Rotate Token</legend>
            <label>Token ID: <input name="target_id" placeholder="primary" required></label>
            <label>New Value: <input name="new_value" required></label>
            <input type="hidden" name="token" value="{{ admin_token }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" onclick="return confirm('Rotate this token now?');">Rotate</button>
          </fieldset>
        </form>
      {% endif %}
    {% endif %}
    <p><a href="{{ ci_url }}" target="_blank">View CI dashboard</a></p>
    <p><a href="{{ pages_url }}" target="_blank">View Pages site</a></p>

    <form action="/release_now" method="post" onsubmit="return confirmRelease(this);">
      <input type="hidden" name="token" value="{{ admin_token }}">
      <input type="hidden" name="confirm_release" value="yes">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <button type="submit">Release Now</button>
    </form>

    <form action="/trigger_workflow" method="post" onsubmit="return confirmTrigger(this);">
      <input type="hidden" name="token" value="{{ admin_token }}">
      <input type="hidden" name="confirm_trigger" value="yes">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label>Workflow file: <input name="workflow" value="ci.yml"></label>
      <label>ref: <input name="ref" value="main"></label>
      <button type="submit">Trigger CI</button>
    </form>

    <form action="/admin/run_tests" method="post" onsubmit="return confirmRunTests(this);">
      <input type="hidden" name="token" value="{{ admin_token }}">
      <input type="hidden" name="confirm_run_tests" value="yes">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <label>Test path: <input name="test_path" value="tests/" placeholder="tests/ or tests/test_app.py"></label>
      <label><input type="checkbox" name="verbose"> Verbose output</label>
      <button type="submit">Run Tests</button>
    </form>

  <p><a href="/release_history?token={{ admin_token }}">View Release History</a></p>
  <p><a href="/sbom?token={{ admin_token }}">View SBOMs</a></p>
  <script>
    function confirmRelease(form){
      return confirm('Confirm creating a release tag now?');
    }
    function confirmTrigger(form){
      return confirm('Trigger the specified workflow now?');
    }
    function confirmRunTests(form){
      return confirm('Run tests now? This may take up to 2 minutes.');
    }
  </script>
  </body>
</html>
