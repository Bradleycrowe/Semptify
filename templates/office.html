{% extends "shell.html" %}

{% block title %}Semptify Office{% endblock %}

{% block head_extra %}
<style>
  .office-section { margin-bottom: 1.5rem; }
  .doc-card { border:1px solid #eee; padding:8px; margin-top:8px; }
  .rooms-list .room { padding:8px; border:1px solid #ddd; margin-top:8px; }
  .small-muted { color:#6c757d; font-size:0.9rem; }
  .office-grid { display:flex; gap:1rem; flex-direction:column; }
</style>
{% endblock %}

{% block left_sidebar %}
<div>
  <h5>Office Quick Actions</h5>
  <ul class="list-unstyled">
    <li><button class="btn btn-sm btn-outline-primary" onclick="createRoomUI()">Create Room</button></li>
    <li class="mt-2"><a class="btn btn-sm btn-outline-secondary" href="/vault">Open Vault</a></li>
    <li class="mt-2"><a class="btn btn-sm btn-outline-secondary" href="/help">Help</a></li>
  </ul>
</div>
{% endblock %}

{% block page_title %}
<h2>Semptify Office</h2>
<small class="small-muted">Certified Rooms 路 Notary Station 路 Document Center 路 Live Review 路 AI Orchestrator</small>
{% endblock %}

{% block content %}
<div class="office-grid">
  <section class="office-section" id="rooms-section">
    <h4>Rooms</h4>
    <div class="d-flex gap-2 align-items-center mb-2">
      <select id="room-type" class="form-select form-select-sm" style="width:auto">
        <option value="open">Organizer Workspace</option>
        <option value="certified">Certified Counsel Room</option>
        <option value="notary">Notary Station</option>
      </select>
      <button class="btn btn-sm btn-primary" onclick="createRoomUI()">Create Room</button>
    </div>
    <div id="rooms-list" class="rooms-list"></div>
  </section>

  <section class="office-section" id="documents-section">
    <h4>Document Center</h4>
    <div class="mb-2">
      <input id="file-input" type="file" />
      <span id="upload-state" class="ms-2 small-muted"></span>
    </div>
    <div id="documents-list"></div>
  </section>

  <section class="office-section" id="live-review-section">
    <h4>Live Review</h4>
    <div class="mb-2">
      <textarea id="annotation-text" class="form-control" rows="3" placeholder="Time-stamped note"></textarea>
      <button class="btn btn-sm btn-outline-primary mt-2" onclick="addAnnotationSelected()">Add Annotation to Selected</button>
    </div>
  </section>

  <section class="office-section" id="ai-section">
    <h4>Cross-AI Workspace</h4>
    <div class="mb-2">
      <button class="btn btn-sm btn-success" onclick="orchestrateSelected()">Start 3-AI Orchestration</button>
      <div id="ai-job" class="mt-2 small-muted"></div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// Minimal client for the Office demo endpoints (vanilla JS)
async function fetchJSON(url, opts) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + url);
  const ct = res.headers.get('content-type') || '';
  if (ct.indexOf('application/json') !== -1) return res.json();
  return res.text();
}

async function fetchRooms() {
  try {
    const rooms = await fetchJSON('/api/rooms');
    const container = document.getElementById('rooms-list');
    container.innerHTML = '';
    rooms.forEach(r => {
      const div = document.createElement('div');
      div.className = 'room';
      div.innerHTML = `<strong>${r.type}</strong> <small class="small-muted">${r.id}</small>
        <div class="mt-1"><button class="btn btn-sm btn-outline-primary" onclick="joinRoom('${r.id}')">Join</button></div>`;
      container.appendChild(div);
    });
  } catch (e) {
    console.warn('fetchRooms', e);
  }
}

async function createRoomUI() {
  const type = document.getElementById('room-type').value;
  try {
    await fetchJSON('/api/rooms/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, expires_in:3600}) });
    await fetchRooms();
  } catch (e) { console.warn('createRoom', e); }
}

async function joinRoom(roomId) {
  try {
    const tok = await fetchJSON(`/api/rooms/${roomId}/token`, { method:'POST' });
    const url = `/video/?room=${roomId}&token=${tok.token}`;
    window.open(url, '_blank');
  } catch (e) { console.warn('joinRoom', e); }
}

// Documents
async function fetchDocuments() {
  try {
    const docs = await fetchJSON('/api/documents');
    const container = document.getElementById('documents-list');
    container.innerHTML = '';
    docs.forEach(d => {
      const card = document.createElement('div');
      card.className = 'doc-card';
      const sha = d.sha256 ? `<div><small class="small-muted">SHA256: ${d.sha256}</small></div>` : '';
      card.innerHTML = `<div><strong>${d.filename || d.id}</strong> ${sha}</div>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary" onclick="lockDocument('${d.id}')">Timestamp & Lock</button>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="selectDocument('${d.id}')">Select</button>
          <button class="btn btn-sm btn-link ms-2" onclick="window.open('/files/${d.id}','_blank')">View</button>
        </div>`;
      container.appendChild(card);
    });
  } catch (e) { console.warn('fetchDocuments', e); }
}

let selectedDocId = null;
function selectDocument(id) { selectedDocId = id; alert('Selected ' + id); }

async function computeSHA256(file) {
  const ab = await file.arrayBuffer();
  const hash = await crypto.subtle.digest('SHA-256', ab);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

document.getElementById('file-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const state = document.getElementById('upload-state');
  state.textContent = 'Hashing...';
  try {
    const sha = await computeSHA256(file);
    state.textContent = 'Uploading...';
    const init = await fetchJSON('/api/documents/upload/init', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: file.name, size: file.size, sha256: sha }) });
    // backend_demo returns uploadUrl (string) and id
    const uploadUrl = init.uploadUrl || init.uploadUrl || init.uploadUrl; // defensive
    const id = init.id || init.id;
    // upload via PUT
    await fetch(uploadUrl, { method:'PUT', body: file });
    await fetchJSON(`/api/documents/${id}/complete`, { method:'POST' });
    state.textContent = 'Uploaded';
    await fetchDocuments();
  } catch (err) {
    console.error('upload error', err);
    state.textContent = 'Upload failed';
  }
});

async function lockDocument(docId) {
  try {
    await fetchJSON(`/api/documents/${docId}/lock`, { method:'POST' });
    await fetchDocuments();
  } catch (e) { console.warn('lockDocument', e); }
}

async function addAnnotationSelected() {
  const text = document.getElementById('annotation-text').value;
  if (!selectedDocId) return alert('Select a document first');
  try {
    await fetchJSON(`/api/documents/${selectedDocId}/annotate`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, timecode: new Date().toISOString() }) });
    document.getElementById('annotation-text').value = '';
    await fetchDocuments();
  } catch (e) { console.warn('addAnnotationSelected', e); }
}

async function orchestrateSelected() {
  if (!selectedDocId) return alert('Select at least one document');
  try {
    const res = await fetchJSON('/api/ai/orchestrate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ requester:'web_client', input_refs:[selectedDocId], ais:[{name:'summarizer',role:'summarizer'},{name:'draftr',role:'drafter'},{name:'redteam',role:'red-teamer'}], strategy:'synthesize', approval_required:true }) });
    document.getElementById('ai-job').textContent = 'AI job created ' + res.job_id;
  } catch (e) { console.warn('orchestrateSelected', e); }
}

// Initial load
fetchRooms();
fetchDocuments();
</script>
{% endblock %}
