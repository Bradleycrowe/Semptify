<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledger & Calendar Dashboard - Semptify</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
  <style>
    :root {
      --primary-color: #0078d7;
      --secondary-color: #107c10;
      --accent-color: #ffc107;
      --danger-color: #d13438;
      --light-bg: #f8f9fa;
      --dark-text: #222;
      --border-color: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    /* ========== HEADER ========== */
    .header {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--primary-color);
      text-decoration: none;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn-header {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .btn-primary-header {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary-header:hover {
      background: #005a9e;
    }

    /* ========== MAIN CONTAINER ========== */
    .container-main {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: var(--dark-text);
    }

    /* ========== TAB NAVIGATION ========== */
    .tab-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      margin-bottom: 30px;
    }

    .nav-tabs {
      border-bottom: 2px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 16px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .nav-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .nav-tab:hover {
      color: var(--primary-color);
    }

    /* ========== TAB CONTENT ========== */
    .tab-content {
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* ========== CALENDAR SECTION ========== */
    .calendar-wrapper {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    #calendar {
      font-size: 0.95rem;
    }

    .fc-button-primary {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
    }

    .fc-button-primary:hover {
      background-color: #005a9e !important;
    }

    .fc-button-primary:not(:disabled).fc-button-active {
      background-color: #005a9e !important;
    }

    /* ========== LEDGER SECTION ========== */
    .ledger-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .ledger-table thead {
      background: var(--light-bg);
      border-bottom: 2px solid var(--border-color);
    }

    .ledger-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark-text);
    }

    .ledger-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .ledger-table tbody tr:hover {
      background: var(--light-bg);
    }

    .entry-type {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .type-payment {
      background: #e8f5e9;
      color: var(--secondary-color);
    }

    .type-document {
      background: #e3f2fd;
      color: var(--primary-color);
    }

    .type-complaint {
      background: #fff3e0;
      color: #f57c00;
    }

    .type-evidence {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .type-notice {
      background: #fce4ec;
      color: #c2185b;
    }

    .type-action {
      background: #fff8e1;
      color: #f9a825;
    }

    /* ========== FORM SECTION ========== */
    .form-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      margin-bottom: 20px;
    }

    .form-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--dark-text);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-text);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 120, 215, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .btn-submit {
      background: var(--primary-color);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    .btn-submit:hover {
      background: #005a9e;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 120, 215, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: var(--dark-text);
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* ========== STATUS MESSAGE ========== */
    .status-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.success {
      background: #e8f5e9;
      color: var(--secondary-color);
      border-left: 4px solid var(--secondary-color);
    }

    .status-message.error {
      background: #ffebee;
      color: var(--danger-color);
      border-left: 4px solid var(--danger-color);
    }

    .status-message.info {
      background: #e3f2fd;
      color: var(--primary-color);
      border-left: 4px solid var(--primary-color);
    }

    /* ========== STATS CARDS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border-left: 4px solid var(--primary-color);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark-text);
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .header-content {
        flex-wrap: wrap;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .nav-tabs {
        overflow-x: auto;
      }

      .nav-tab {
        padding: 12px 16px;
        font-size: 0.85rem;
        white-space: nowrap;
      }

      .tab-content {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .ledger-table {
        font-size: 0.85rem;
      }

      .ledger-table th,
      .ledger-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- ========== HEADER ========== -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">üìã Semptify Ledger & Calendar</a>
      <div class="header-actions">
        <button class="btn-header btn-primary-header" onclick="window.location.href='/admin'">Dashboard</button>
      </div>
    </div>
  </header>

  <!-- ========== MAIN CONTENT ========== -->
  <div class="container-main">
    <h1 class="page-title">Rent Ledger & Calendar</h1>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Entries</div>
        <div class="stat-value" id="total-entries">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Payment Records</div>
        <div class="stat-value" id="total-payments">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Documents</div>
        <div class="stat-value" id="total-documents">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Upcoming Events</div>
        <div class="stat-value" id="upcoming-events">0</div>
      </div>
    </div>

    <!-- STATUS MESSAGE -->
    <div id="status-message" class="status-message"></div>

    <!-- TABS -->
    <div class="tab-container">
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('calendar')">üìÖ Calendar</button>
        <button class="nav-tab" onclick="switchTab('ledger')">üìä Ledger</button>
        <button class="nav-tab" onclick="switchTab('add-entry')">‚ûï Add Entry</button>
        <button class="nav-tab" onclick="switchTab('add-event')">üóìÔ∏è Add Event</button>
      </div>

      <!-- CALENDAR TAB -->
      <div id="calendar-tab" class="tab-pane active">
        <div class="calendar-wrapper">
          <div id="calendar"></div>
        </div>
      </div>

      <!-- LEDGER TAB -->
      <div id="ledger-tab" class="tab-pane">
        <div class="tab-content">
          <h3 style="margin-bottom: 20px;">Rent & Action Ledger</h3>
          <div style="overflow-x: auto;">
            <table class="ledger-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Actor</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="ledger-body">
                <tr>
                  <td colspan="5" style="text-align: center; color: #999;">Loading entries...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-submit" onclick="exportLedger()">üì• Export for Court</button>
          </div>
        </div>
      </div>

      <!-- ADD ENTRY TAB -->
      <div id="add-entry-tab" class="tab-pane">
        <div class="tab-content">
          <div class="form-section">
            <h3 class="form-title">Add Ledger Entry</h3>
            <form onsubmit="addEntry(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Entry Type *</label>
                  <select class="form-select" id="entry-type" required>
                    <option value="">Select Type</option>
                    <option value="payment">üí∞ Payment</option>
                    <option value="document">üìÑ Document</option>
                    <option value="complaint">‚ö†Ô∏è Complaint</option>
                    <option value="evidence">üì∏ Evidence</option>
                    <option value="notice">üìã Notice</option>
                    <option value="action">‚úÖ Action</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Date *</label>
                  <input type="date" class="form-input" id="entry-date" required>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Description *</label>
                <input type="text" class="form-input" id="entry-description" placeholder="e.g., Rent payment, Security deposit, Lease received" required>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Amount (if applicable)</label>
                  <input type="number" class="form-input" id="entry-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                  <label class="form-label">Reference/ID</label>
                  <input type="text" class="form-input" id="entry-reference" placeholder="Check #, Receipt #, etc.">
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="entry-notes" placeholder="Additional details or context..."></textarea>
              </div>

              <div>
                <button type="submit" class="btn-submit">Add Entry</button>
                <button type="reset" class="btn-secondary">Clear</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ADD EVENT TAB -->
      <div id="add-event-tab" class="tab-pane">
        <div class="tab-content">
          <div class="form-section">
            <h3 class="form-title">Add Calendar Event</h3>
            <form onsubmit="addEvent(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Event Title *</label>
                  <input type="text" class="form-input" id="event-title" placeholder="e.g., Rent Due, Court Date, Inspection" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Event Type *</label>
                  <select class="form-select" id="event-type" required>
                    <option value="">Select Type</option>
                    <option value="deadline">üìÖ Deadline</option>
                    <option value="reminder">üîî Reminder</option>
                    <option value="action_needed">‚ö° Action Needed</option>
                    <option value="completed">‚úÖ Completed</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Start Date *</label>
                  <input type="datetime-local" class="form-input" id="event-start" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Priority</label>
                  <select class="form-select" id="event-priority">
                    <option value="0">‚¨ú Low</option>
                    <option value="1" selected>üü° Medium</option>
                    <option value="2">üî¥ High</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="event-description" placeholder="Event details and context..."></textarea>
              </div>

              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="event-completed"> Mark as completed
                </label>
              </div>

              <div>
                <button type="submit" class="btn-submit">Add Event</button>
                <button type="reset" class="btn-secondary">Clear</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    let calendar;
    let ledgerEntries = [];
    let calendarEvents = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initCalendar();
      loadLedger();
      loadCalendarEvents();
      setDefaultDates();
    });

    // Initialize FullCalendar
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: loadCalendarEventsForFC
      });
      calendar.render();
    }

    // Load calendar events for FullCalendar
    function loadCalendarEventsForFC(info, successCallback, failureCallback) {
      fetch('/api/ledger-calendar/calendar')
        .then(r => r.json())
        .then(data => {
          const events = (data.events || []).map(e => ({
            id: e.id,
            title: e.title,
            start: e.start_time,
            end: e.end_time,
            backgroundColor: getPriorityColor(e.priority),
            borderColor: getPriorityColor(e.priority)
          }));
          successCallback(events);
        })
        .catch(e => {
          console.error('Error loading calendar:', e);
          failureCallback(e);
        });
    }

    // Get priority color
    function getPriorityColor(priority) {
      switch(priority) {
        case 0: return '#6c757d'; // low
        case 1: return '#ffc107'; // medium
        case 2: return '#d13438'; // high
        default: return '#0078d7';
      }
    }

    // Load ledger entries
    function loadLedger() {
      fetch('/api/ledger-calendar/ledger?limit=100')
        .then(r => r.json())
        .then(data => {
          ledgerEntries = data.entries || [];
          updateStats();
          renderLedgerTable();
        })
        .catch(e => console.error('Error loading ledger:', e));
    }

    // Load calendar events
    function loadCalendarEvents() {
      fetch('/api/ledger-calendar/calendar')
        .then(r => r.json())
        .then(data => {
          calendarEvents = data.events || [];
          updateStats();
        })
        .catch(e => console.error('Error loading events:', e));
    }

    // Update statistics
    function updateStats() {
      document.getElementById('total-entries').textContent = ledgerEntries.length;
      document.getElementById('total-payments').textContent =
        ledgerEntries.filter(e => e.entry_type === 'payment').length;
      document.getElementById('total-documents').textContent =
        ledgerEntries.filter(e => e.entry_type === 'document').length;
      document.getElementById('upcoming-events').textContent =
        calendarEvents.filter(e => new Date(e.start_time) > new Date()).length;
    }

    // Render ledger table
    function renderLedgerTable() {
      const tbody = document.getElementById('ledger-body');
      if (ledgerEntries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No entries yet</td></tr>';
        return;
      }

      tbody.innerHTML = ledgerEntries.map(e => `
        <tr>
          <td>${new Date(e.timestamp * 1000).toLocaleDateString()}</td>
          <td><span class="entry-type type-${e.entry_type}">${e.entry_type.toUpperCase()}</span></td>
          <td><strong>${e.description}</strong></td>
          <td>${e.actor || 'User'}</td>
          <td>${e.amount ? '$' + e.amount.toFixed(2) : e.reference || '-'}</td>
        </tr>
      `).join('');
    }

    // Add entry
    function addEntry(e) {
      e.preventDefault();
      const entry = {
        entry_type: document.getElementById('entry-type').value,
        description: document.getElementById('entry-description').value,
        actor: 'user',
        amount: parseFloat(document.getElementById('entry-amount').value) || null,
        reference: document.getElementById('entry-reference').value || null,
        notes: document.getElementById('entry-notes').value || null
      };

      fetch('/api/ledger-calendar/log-action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      })
        .then(r => r.json())
        .then(data => {
          showStatus('Entry added successfully!', 'success');
          e.target.reset();
          loadLedger();
        })
        .catch(err => showStatus('Error adding entry: ' + err, 'error'));
    }

    // Add event
    function addEvent(e) {
      e.preventDefault();
      const event = {
        title: document.getElementById('event-title').value,
        event_type: document.getElementById('event-type').value,
        start_time: new Date(document.getElementById('event-start').value).toISOString(),
        priority: parseInt(document.getElementById('event-priority').value),
        description: document.getElementById('event-description').value,
        completed: document.getElementById('event-completed').checked
      };

      fetch('/api/ledger-calendar/schedule-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(event)
      })
        .then(r => r.json())
        .then(data => {
          showStatus('Event added successfully!', 'success');
          e.target.reset();
          loadCalendarEvents();
          calendar.refetchEvents();
        })
        .catch(err => showStatus('Error adding event: ' + err, 'error'));
    }

    // Export ledger
    function exportLedger() {
      fetch('/api/ledger-calendar/ledger/export', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(r => r.json())
        .then(data => {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ledger-export-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          showStatus('Ledger exported successfully!', 'success');
        })
        .catch(err => showStatus('Error exporting ledger: ' + err, 'error'));
    }

    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');

      if (tabName === 'calendar' && calendar) {
        calendar.render();
      }
    }

    // Show status message
    function showStatus(message, type) {
      const msg = document.getElementById('status-message');
      msg.textContent = message;
      msg.className = `status-message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 5000);
    }

    // Set default dates
    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('entry-date').value = today;
      document.getElementById('event-start').value = new Date().toISOString().slice(0, 16);
    }
  </script>
</body>
</html>
