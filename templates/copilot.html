<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Semptify Copilot</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    {% extends "shell.html" %}

    {% block title %}Copilot{% endblock %}

    {% block content %}
    <div class="card narrow">
      <h1>Copilot</h1>
      <p class="muted">Ask Semptify AI for help with forms, letters, and next steps.</p>
      <form id="copilot-form" action="/api/copilot" method="post">
        <label for="prompt">Ask a question</label>
        <textarea id="prompt" name="prompt" rows="4"></textarea>
        <button type="submit">Ask</button>
      </form>
    </div>
    {% include '_footer.html' %}
    {% endblock %}

    {% block scripts %}
    <script>
      const form = document.getElementById('copilot-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = { prompt: document.getElementById('prompt').value };
        const r = await fetch('/api/copilot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const json = await r.json();
        alert(json.result || 'No result');
      });
    </script>
    {% endblock %}
        e.preventDefault();
        const prompt = document.getElementById('prompt').value.trim();
        const csrf = form.querySelector('input[name="csrf_token"]').value;
        if(!prompt){ answer.textContent = 'Please enter a prompt.'; return; }
        answer.textContent = 'Thinking...';
        try {
          const citations = document.getElementById('citations').checked;
          const r = await fetch('/api/copilot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf },
            body: JSON.stringify({ prompt, citations })
          });
          const data = await r.json();
          if(!r.ok){
            answer.textContent = `Error (${r.status}): ${data && data.error ? data.error : 'Unknown error'}`;
          } else {
            answer.textContent = data.output || '(empty)';
          }
        } catch(err){
          answer.textContent = 'Network error: ' + err;
        }
      });
    </script>
    {% include '_footer.html' %}
  </body>
  <script src="/static/js/help-panel.js"></script>
</html>
