<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Evidence Collection</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    <style>
      .evidence-form {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .location-info {
        background: #f0f0f0;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
      }
      .audio-controls {
        margin: 15px 0;
      }
      .audio-controls button {
        margin-right: 10px;
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .audio-controls button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .audio-controls button.recording {
        background: #dc3545;
      }
      .evidence-list {
        max-width: 800px;
        margin: 20px auto;
      }
      .evidence-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
      }
      .evidence-item h3 {
        margin-top: 0;
      }
      .timestamp {
        color: #666;
        font-size: 0.9em;
      }
      .ai-analysis {
        background: #e7f3ff;
        padding: 10px;
        border-left: 3px solid #007bff;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .analyze-btn {
        margin-top: 10px;
        padding: 8px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Evidence Collection</h1>
    <p>Welcome, {{ user.name }}. Collect and document evidence with timestamps, location, and audio recordings.</p>

    <div class="evidence-form">
      <h2>Submit New Evidence</h2>
      <form id="evidenceForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required placeholder="Brief summary of the evidence">
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" rows="6" required placeholder="Detailed description of what happened, when, where, and who was involved..."></textarea>
          <button type="button" class="analyze-btn" onclick="analyzeEvidence()">ü§ñ Get AI Analysis</button>
          <div id="aiAnalysis" class="ai-analysis" style="display: none;"></div>
        </div>

        <div class="form-group">
          <label>Location (optional)</label>
          <button type="button" onclick="getLocation()">üìç Get Current Location</button>
          <div id="locationInfo" class="location-info" style="display: none;">
            <p><strong>Latitude:</strong> <span id="lat"></span></p>
            <p><strong>Longitude:</strong> <span id="lng"></span></p>
            <p><strong>Address:</strong> <span id="address"></span></p>
          </div>
          <input type="hidden" id="location_lat" name="location_lat">
          <input type="hidden" id="location_lng" name="location_lng">
          <input type="hidden" id="location_address" name="location_address">
        </div>

        <div class="form-group">
          <label>Audio Recording (optional)</label>
          <div class="audio-controls">
            <button type="button" id="recordBtn" onclick="toggleRecording()">üé§ Start Recording</button>
            <button type="button" id="playBtn" onclick="playRecording()" disabled>‚ñ∂Ô∏è Play</button>
            <button type="button" id="clearBtn" onclick="clearRecording()" disabled>üóëÔ∏è Clear</button>
            <span id="recordingStatus"></span>
          </div>
          <audio id="audioPlayback" controls style="display: none; width: 100%;"></audio>
        </div>

        <button type="submit">Submit Evidence</button>
      </form>
    </div>

    <div class="evidence-list">
      <h2>Your Evidence Items</h2>
      {% if items %}
        {% for item in items %}
        <div class="evidence-item">
          <h3>{{ item.title }}</h3>
          <p class="timestamp">üìÖ {{ item.timestamp }}</p>
          <p>{{ item.description }}</p>
          
          {% if item.location %}
          <p>üìç Location: {{ item.location.address or (item.location.lat ~ ', ' ~ item.location.lng) }}</p>
          {% endif %}
          
          {% if item.audio_file %}
          <p>üé§ <a href="/api/evidence/download/{{ item.id }}">Download Audio Recording</a></p>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <p>No evidence items yet. Submit your first evidence above.</p>
      {% endif %}
    </div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let audioBlob;

      async function getLocation() {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser');
          return;
        }

        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 10000
            });
          });

          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          document.getElementById('location_lat').value = lat;
          document.getElementById('location_lng').value = lng;
          document.getElementById('lat').textContent = lat.toFixed(6);
          document.getElementById('lng').textContent = lng.toFixed(6);

          // Try to get address via reverse geocoding (if available)
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
            const data = await response.json();
            const address = data.display_name || `${lat}, ${lng}`;
            document.getElementById('location_address').value = address;
            document.getElementById('address').textContent = address;
          } catch (e) {
            document.getElementById('address').textContent = `${lat}, ${lng}`;
          }

          document.getElementById('locationInfo').style.display = 'block';
        } catch (error) {
          alert('Unable to get location: ' + error.message);
        }
      }

      async function toggleRecording() {
        const btn = document.getElementById('recordBtn');
        const status = document.getElementById('recordingStatus');

        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
              audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = document.getElementById('audioPlayback');
              audio.src = audioUrl;
              audio.style.display = 'block';
              document.getElementById('playBtn').disabled = false;
              document.getElementById('clearBtn').disabled = false;
              status.textContent = '';
              btn.classList.remove('recording');
            };

            mediaRecorder.start();
            btn.textContent = '‚èπÔ∏è Stop Recording';
            btn.classList.add('recording');
            status.textContent = 'üî¥ Recording...';
          } catch (error) {
            alert('Unable to access microphone: ' + error.message);
          }
        } else {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
          btn.textContent = 'üé§ Start Recording';
        }
      }

      function playRecording() {
        document.getElementById('audioPlayback').play();
      }

      function clearRecording() {
        audioBlob = null;
        audioChunks = [];
        document.getElementById('audioPlayback').style.display = 'none';
        document.getElementById('playBtn').disabled = true;
        document.getElementById('clearBtn').disabled = true;
      }

      async function analyzeEvidence() {
        const description = document.getElementById('description').value.trim();
        if (!description) {
          alert('Please enter a description first');
          return;
        }

        const analysisDiv = document.getElementById('aiAnalysis');
        analysisDiv.textContent = 'Analyzing...';
        analysisDiv.style.display = 'block';

        try {
          const response = await fetch('/api/evidence/analyze', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              description: description,
              csrf_token: '{{ csrf_token }}'
            })
          });

          const data = await response.json();
          if (data.analysis) {
            analysisDiv.textContent = 'ü§ñ AI Analysis:\n\n' + data.analysis;
          } else {
            analysisDiv.textContent = 'Analysis failed: ' + (data.error || 'Unknown error');
          }
        } catch (error) {
          analysisDiv.textContent = 'Analysis failed: ' + error.message;
        }
      }

      document.getElementById('evidenceForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);

        // Add audio if recorded
        if (audioBlob) {
          formData.append('audio', audioBlob, 'recording.webm');
        }

        try {
          const response = await fetch('/api/evidence/submit', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          if (result.success) {
            alert('Evidence submitted successfully!');
            window.location.reload();
          } else {
            alert('Submission failed: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          alert('Submission failed: ' + error.message);
        }
      });
    </script>
  </body>
</html>
