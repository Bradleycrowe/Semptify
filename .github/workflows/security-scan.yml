name: Security Scan (Secrets + Dependencies)

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  schedule:
    # Nightly scan for new vulnerabilities
    - cron: '0 2 * * *'

jobs:
  detect-secrets:
    name: Detect Secrets (detect-secrets)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret detection

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run secret detection
        run: |
          echo "ðŸ” Scanning for secrets..."
          detect-secrets scan --baseline .secrets.baseline --allow-missing-credentials > /tmp/secrets-scan.txt 2>&1 || true
          cat /tmp/secrets-scan.txt
          # Fail if new secrets found (not in baseline)
          detect-secrets audit .secrets.baseline > /tmp/audit.txt 2>&1 || true
          if grep -q "Potential secrets found" /tmp/secrets-scan.txt; then
            echo "âŒ Potential secrets detected! Review and add to baseline if safe."
            exit 1
          else
            echo "âœ… No new secrets detected."
          fi

  dependency-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pip-audit safety

      - name: Run pip-audit
        run: |
          echo "ðŸ” Auditing Python dependencies with pip-audit..."
          pip-audit --desc || true
          echo ""

      - name: Run safety check
        run: |
          echo "ðŸ” Running safety check..."
          safety check --json > /tmp/safety-report.json || true
          python -m json.tool /tmp/safety-report.json 2>/dev/null || cat /tmp/safety-report.json || echo "No vulnerabilities found"

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports-${{ github.run_id }}
          path: /tmp/

  bandit-security:
    name: Python Security Linter (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install bandit
        run: |
          pip install bandit

      - name: Run bandit scan
        run: |
          echo "ðŸ” Running bandit security scan..."
          bandit -r . -ll --skip B101,B601 -f json -o /tmp/bandit-report.json || true
          bandit -r . -ll --skip B101,B601 || true

      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ github.run_id }}
          path: /tmp/bandit-report.json

  sbom-validation:
    name: SBOM Generation & Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.19.0

      - name: Generate SBOM
        run: |
          echo "ðŸ“‹ Generating SBOM..."
          syft dir:. -o json > sbom.json
          syft dir:. -o table
          echo ""
          echo "SBOM file size: $(wc -c < sbom.json) bytes"
          test -s sbom.json && echo "âœ… SBOM generated successfully" || echo "âŒ SBOM is empty"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.json

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [ detect-secrets, dependency-audit, bandit-security, sbom-validation ]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "================================"
          echo "ðŸ” Security Scan Summary"
          echo "================================"
          echo "âœ… Detect-secrets: ${{ needs.detect-secrets.result }}"
          echo "âœ… Dependency-audit: ${{ needs.dependency-audit.result }}"
          echo "âœ… Bandit-security: ${{ needs.bandit-security.result }}"
          echo "âœ… SBOM-validation: ${{ needs.sbom-validation.result }}"
          echo ""
          echo "Review artifacts for detailed reports."
